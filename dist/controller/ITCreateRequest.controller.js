sap.ui.define(["./BaseController","sap/ui/model/json/JSONModel","sap/ui/core/routing/History","sap/m/MessageBox","sap/ui/model/Filter","sap/ui/model/FilterOperator","sap/m/MessageToast"],function(e,t,r,i,o,a,l){"use strict";return e.extend("com.swcc.Template.controller.ITCreateRequest",{onInit:function(){this.oRouter=this.getRouter();this.getRouter().getRoute("ITCreateRequest").attachPatternMatched(this._onObjectMatched,this)},_onObjectMatched:function(){this._createItemDataModel();var e=jQuery.sap.storage(jQuery.sap.storage.Type.local),t=e.get("sSubServiceType");var r=t.split("_")[0];var i=t.split("_")[1];this.getModel().setProperty("/ITAppVisible/",r);this.getModel().setProperty("/ServiceDescription",i);var o=this.handlegetlocalStorage("userPlant");this.getModel().setProperty("/PlantF4",o)},_createItemDataModel:function(){this.getModel().setData({busy:false,UploadedData:[],PlantF4:"",ITProcurement:{Header:{},itemData:[]},NonITProcurement:{Header:{}}})},onValueHelpRequest:function(e){debugger;var t=e.getSource().getBindingContext()?parseInt(e.getSource().getBindingContext().getPath().split("/")[3]):"";this.getModel().setProperty("/itemIndex",t);var r=this.handleItemValuehelps(t,e.getSource().getAriaLabelledBy()[0].split("-")[6]);this.getModel().setProperty("/valueHelpName",e.getSource().getAriaLabelledBy()[0].split("-")[6]);var i=e.getSource().getAriaLabelledBy()[0].split("-")[3];var o=e.getSource().getAriaLabelledBy()[0].split("-")[4];var a=e.getSource().getAriaLabelledBy()[0].split("-")[5];var l=r===""?e.getSource().getAriaLabelledBy()[0].split("-")[6]:r;this.getModel().setProperty("/FragModel",l);this.handleFiltersForValueHelp(this.getModel().getProperty("/FragModel"));var s=e.getSource().getCustomData()[0].getKey();var n=e.getSource().getCustomData()[0].getValue();var g=e.getSource().getCustomData()[1].getKey();var p=e.getSource().getCustomData()[1].getValue();this.getModel().setProperty("/valueHelpKey1",s);this.getModel().setProperty("/valueHelpKey2",g);var u=this.getOwnerComponent().getModel(i);var d=[{label:n,template:s,width:"10rem"},{label:p,template:g}];this.onHandleValueHelpRequest(u,d,o,a)},handleItemValuehelps:function(e,t){if(e===""){this.getModel().setProperty("/HeaderValueHelp",true);return""}this.getModel().setProperty("/HeaderValueHelp",false);var r;r=this.getModel().getProperty("/ITAppVisible/")==="SSA-IT-4001-2"&&this.getModel().getProperty("/ITProcurement/itemData").length!==0?`/ITProcurement/itemData/${e}${t}`:r;r=this.getModel().getProperty("/ITAppVisible/")==="SSA-IT-4003-2"&&this.getModel().getProperty("/ITProcurement/itemData").length!==0?`/ITProcurement/itemData/${e}${t}`:r;r=this.getModel().getProperty("/ITAppVisible/")==="SSA-IT-4003-3"&&this.getModel().getProperty("/ITProcurement/itemData").length!==0?`/ITProcurement/itemData/${e}${t}`:r;r=this.getModel().getProperty("/ITAppVisible/")==="SSA-IT-4003-1"&&this.getModel().getProperty("/ITProcurement/itemData").length!==0?`/ITProcurement/itemData/${e}${t}`:r;return r},onValueHelpOkPress:function(e){var t=this.getModel().getProperty("/FragModel");var r=e.getParameter("tokens");var i=this.getModel().getProperty("/valueHelpKey1");var o=this.getModel().getProperty("/valueHelpKey2");var a=this.getModel();var t=t;this.onHandleValueHelpOkPress(a,t,r,i,o);this.setDependentFilterData()},setDependentFilterData:function(){if(this.getModel().getProperty("/ITAppVisible/")==="SSA-IT-4001-2"&&!this.getModel().getProperty("/HeaderValueHelp")&&this.getModel().getProperty("/valueHelpName")==="/MaterialF4/"){var e=[{path:"ProductGroup",value:"IT001",group:"ComputerDeviceFilter",useOR:true},{path:"Product",value:this.getModel().getProperty(`/ITProcurement/itemData/${this.getModel().getProperty("/itemIndex")}/MaterialF4/`).split("-")[0],group:"ComputerDeviceFilter"}];var t=this.getFilters(e);this.callDependentFilterAPI("ZSSP_SCM_SRV","/ZCDSV_ITMATERIALVH",t.ComputerDeviceFilter,`/ITProcurement/itemData/${this.getModel().getProperty("/itemIndex")}`)}else if(this.getModel().getProperty("/ITAppVisible/")==="SSA-IT-4003-2"&&!this.getModel().getProperty("/HeaderValueHelp")&&this.getModel().getProperty("/valueHelpName")==="/MaterialF4/"){var e=[{path:"ProductGroup",value:"IT001",group:"HomeworkingFilter",useOR:true},{path:"Product",value:this.getModel().getProperty(`/ITProcurement/itemData/${this.getModel().getProperty("/itemIndex")}/MaterialF4/`).split("-")[0],group:"HomeworkingFilter"}];var t=this.getFilters(e);this.callDependentFilterAPI("ZSSP_SCM_SRV","/ZCDSV_ITMATERIALVH",t.HomeworkingFilter,`/ITProcurement/itemData/${this.getModel().getProperty("/itemIndex")}`)}else if(this.getModel().getProperty("/ITAppVisible/")==="SSA-IT-4003-3"&&!this.getModel().getProperty("/HeaderValueHelp")&&this.getModel().getProperty("/valueHelpName")==="/MaterialF4/"){var e=[{path:"ProductGroup",value:"IT001",group:"ConferencingFilter",useOR:true},{path:"Product",value:this.getModel().getProperty(`/ITProcurement/itemData/${this.getModel().getProperty("/itemIndex")}/MaterialF4/`).split("-")[0],group:"ConferencingFilter"}];var t=this.getFilters(e);this.callDependentFilterAPI("ZSSP_SCM_SRV","/ZCDSV_ITMATERIALVH",t.ConferencingFilter,`/ITProcurement/itemData/${this.getModel().getProperty("/itemIndex")}`)}else if(this.getModel().getProperty("/ITAppVisible/")==="SSA-IT-4003-1"&&!this.getModel().getProperty("/HeaderValueHelp")&&this.getModel().getProperty("/valueHelpName")==="/MaterialF4/"){var e=[{path:"ProductGroup",value:"IT001",group:"ITTelephonicFilter",useOR:true},{path:"Product",value:this.getModel().getProperty(`/ITProcurement/itemData/${this.getModel().getProperty("/itemIndex")}/MaterialF4/`).split("-")[0],group:"ITTelephonicFilter"}];var t=this.getFilters(e);this.callDependentFilterAPI("ZSSP_SCM_SRV","/ZCDSV_ITMATERIALVH",t.ITTelephonicFilter,`/ITProcurement/itemData/${this.getModel().getProperty("/itemIndex")}`)}},callDependentFilterAPI:function(e,t,r,o){this.getModel().setProperty("/busy",true);this.getAPI.oDataACRUDAPICall(this.getOwnerComponent().getModel(e),"GET",t,null,r,null).then(function(e){this.handleDependentFilterResponse(e.results[0],`${o}`);this.getModel().setProperty("/busy",false)}.bind(this)).catch(function(e){i.error(e.responseText);this.getModel().setProperty("/busy",false)}.bind(this))},handleDependentFilterResponse:function(e,t){this.getModel().setProperty(`${t}/Description/`,e.ProductName);this.getModel().setProperty(`${t}/BaseUnit/`,e.BaseUnit)},onValueHelpCancelPress:function(){this.onHandleValueHelpCancelPress()},onFilterBarSearch:function(e){var t=e.getParameter("selectionSet");var r=[{path:this.getModel().getProperty("/valueHelpKey1"),value:t[0].getValue(),group:"DynamicF4SearchFilter"},{path:this.getModel().getProperty("/valueHelpKey2"),value:t[1].getValue(),operator:sap.ui.model.FilterOperator.Contains,group:"DynamicF4SearchFilter"}];var i=this.getFilters(r);this._filterTable(Object.keys(i).length===0?[]:i.DynamicF4SearchFilter)},handleFiltersForValueHelp:function(e){var t=[{path:"Identifier",value:"Employee Location",group:"EventFilter"},{path:"FiscalYear",value:this.getModel().getProperty("/AccountPayable/ManagePettyCash/Header/FiscalYear")?this.getModel().getProperty("/AccountPayable/ManagePettyCash/Header/FiscalYear"):"",group:"CashJrnlF4Filter"}];var r=this.getFilters(t);var i;if(this.getModel().getProperty("/HRAppVisible/")==="SSA-HR-1004-3"&&e==="/UserijdtF4/"){i=this._getfilterforControl(r.EventFilter)}else if(this.getModel().getProperty("/FinanceAppVisible/")==="SSA-FIN-3003-1"&&e==="/GlaccountF4/"){i=this._getfilterforControl(r.GLF4Filter)}else{i=[]}this.getModel().setProperty("/DynamicValuehelpFilter",i.length==0?[]:i)},onValueHelpAfterOpen:function(){var e=this.getModel().getProperty("/DynamicValuehelpFilter");this._filterTable(e,"Control")},onClearFilter:function(e){var t=e.getParameter("selectionSet");t[0].setValue(null);t[1].setValue(null);this._filterTable(new o({filters:[],and:false}))},_getfilterforControl:function(e){if(!e){return[]}return new o(e)},_filterTable:function(e,t){this.handleVHFilterTable(e,t)},handleBackPress:function(){this.navigationBack()},handleBackHomePress:function(){this.getRouter().navTo("HomePage",{},true)},onProceed:function(){this.getModel().getProperty("/ITAppVisible/")==="SSA-IT-4002-1"?this.ITCreateNonProcuremenRequest(this.getModel().getProperty("/NonITProcurement/Header/"),null):null;this.getModel().getProperty("/ITAppVisible/")==="SSA-IT-4002-2"?this.ITCreateNonProcuremenRequest(this.getModel().getProperty("/NonITProcurement/Header/"),null):null;this.getModel().getProperty("/ITAppVisible/")==="SSA-IT-4003-2"?this.ITCreateProcuremenRequest(this.getModel().getProperty("/ITProcurement/Header/"),this.getModel().getProperty("/ITProcurement/itemData/")):null;this.getModel().getProperty("/ITAppVisible/")==="SSA-IT-4003-3"?this.ITCreateProcuremenRequest(this.getModel().getProperty("/ITProcurement/Header/"),this.getModel().getProperty("/ITProcurement/itemData/")):null;this.getModel().getProperty("/ITAppVisible/")==="SSA-IT-4003-1"?this.ITCreateProcuremenRequest(this.getModel().getProperty("/ITProcurement/Header/"),this.getModel().getProperty("/ITProcurement/itemData/")):null;this.getModel().getProperty("/ITAppVisible/")==="SSA-IT-4001-2"?this.ITCreateProcuremenRequest(this.getModel().getProperty("/ITProcurement/Header/"),this.getModel().getProperty("/ITProcurement/itemData/")):null;this.getModel().getProperty("/ITAppVisible/")==="SSA-IT-4003-2"?this.ITCreateProcuremenRequest(this.getModel().getProperty("/ITProcurement/Header/"),this.getModel().getProperty("/ITProcurement/itemData/")):null;this.getModel().getProperty("/ITAppVisible/")==="SSA-IT-4001-1"?this.ITCreateNonProcuremenRequest(this.getModel().getProperty("/NonITProcurement/Header/"),null):null},handleValidation:function(e){var t=true;var r=!e||e.length===0?false:true;const i=e.some(e=>e.StockAvailable==="Yes");const o=e.some(e=>e.StockAvailable==="No");if(!r){l.show("item Data is required to Submit the request");t=false;return t}if(i&&o||!i&&!o){t=false;l.show("Enter either stock materials or nonstock materials combination is not allowed here.")}return t},ITCreateNonProcuremenRequest:function(e,t){if(!this.handleHeaderValidation(this.getModel().getProperty("/ITAppVisible/")))return;const r=this.getModel().getProperty("/UploadedData").length===0?[]:this.getModel().getProperty("/UploadedData").map(({Filesize:e,...t})=>t);var i={Username:this.getCurrentUserLoggedIn(),Material:this.getModel().getProperty("/ITAppVisible/"),Plant:this.getModel().getProperty("/PlantF4/")?this.getModel().getProperty("/PlantF4/"):"",Descript:e.Descript,NotifText:e.NotifText,ZHeaderExtra:{},ServiceHeadertoItem:[],Attachments:r};this.ITCreateRequestAPI(i)},ITCreateProcuremenRequest:function(e,t){if(!this.handleHeaderValidation(this.getModel().getProperty("/ITAppVisible/"))||!this.handleValidation(t))return;const r=this.getModel().getProperty("/UploadedData").length===0?[]:this.getModel().getProperty("/UploadedData").map(({Filesize:e,...t})=>t);var i={Username:this.getCurrentUserLoggedIn(),Material:this.getModel().getProperty("/ITAppVisible/"),Plant:this.getModel().getProperty("/PlantF4/")?this.getModel().getProperty("/PlantF4/"):"",Descript:e.Descript,NotifText:e.NotifText,Funcloc:`${e.EstPrice}`,ZHeaderExtra:{},ServiceHeadertoItem:t.map(function(e){return{Matnr:e.MaterialF4.split("-")[0],Menge:e.Menge,UnitPrice:Number.isNaN(parseFloat(e.UnitPrice))?"0.00":parseFloat(e.UnitPrice).toFixed(2),TotalPrice:Number.isNaN(parseFloat(e.TotalPrice))?"0.00":parseFloat(e.TotalPrice).toFixed(2)}}),Attachments:r};this.ITCreateRequestAPI(i)},ITCreateRequestAPI:function(e){debugger;this.getModel().setProperty("/busy",true);this.getAPI.oDataACRUDAPICall(this.getOwnerComponent().getModel("ZSSP_COMMON_SRV"),"POST","/ServNotificationSet",e).then(function(e){this._handleMessageBoxProceed(`Service Request has been created : ${e.Notificat}`);this.getModel().setProperty("/busy",false)}.bind(this)).catch(function(e){this._handleError(e);this.getModel().setProperty("/busy",false)}.bind(this))},_handleMessageBoxProceed:function(e){var t={sMessage:e};this.createMessageBoxHandler(this.onPresshomepage.bind(this))(t)},onPresshomepage:function(){this.getOwnerComponent().getRouter().navTo("HomePage")},handleHeaderValidation:function(e){var t=true;var r;if(e==="SSA-IT-4001-1"){r=[{path:"/NonITProcurement/Header/Descript/",condition:true}]}else if(e==="SSA-IT-4001-2"){r=[{path:"/ITProcurement/Header/Descript/",condition:true}]}if(!r)return true;r.forEach(e=>{var r=this.getModel().getProperty(e.path);if(!r||e.condition&&!e.condition){this.getModel().setProperty(e.path,"");this.getModel().setProperty("/ValidationFlag/",true);t=false}});if(!t){l.show("Please Enter all Mandatory Fields")}return t},onAddItemsPress:function(e){this.getModel().getProperty("/ITAppVisible/")==="SSA-IT-4003-2"?this.updateItemAddModel(this.getModel().getProperty("/ITProcurement/itemData"),{MaterialF4:null,Description:"",Menge:"",BaseUnit:"",StockAvailable:"",UnitPrice:"",TotalPrice:""},"/ITProcurement/itemData"):"";this.getModel().getProperty("/ITAppVisible/")==="SSA-IT-4003-3"?this.updateItemAddModel(this.getModel().getProperty("/ITProcurement/itemData"),{MaterialF4:null,Description:"",Menge:"",BaseUnit:"",StockAvailable:"",UnitPrice:"",TotalPrice:""},"/ITProcurement/itemData"):"";this.getModel().getProperty("/ITAppVisible/")==="SSA-IT-4001-2"?this.updateItemAddModel(this.getModel().getProperty("/ITProcurement/itemData"),{MaterialF4:null,Description:"",Menge:"",BaseUnit:"",StockAvailable:"",UnitPrice:"",TotalPrice:""},"/ITProcurement/itemData"):"";this.getModel().getProperty("/ITAppVisible/")==="SSA-IT-4003-1"?this.updateItemAddModel(this.getModel().getProperty("/ITProcurement/itemData"),{MaterialF4:null,Description:"",Menge:"",BaseUnit:"",StockAvailable:"",UnitPrice:"",TotalPrice:""},"/ITProcurement/itemData"):""},updateItemAddModel:function(e,t,r){var i=e.map(function(e){return Object.assign({},e)});i.push(t);this.getModel().setProperty(`${r}`,i)},onDeleteItemPress:function(e){var t=parseInt(e.getSource().getBindingContext().getPath().split("/")[3]);this.getModel().getProperty("/ITAppVisible/")==="SSA-IT-4003-2"?this.updateItemDeleteModel(t,this.getModel().getProperty("/ITProcurement/itemData")):"";this.getModel().getProperty("/ITAppVisible/")==="SSA-IT-4003-3"?this.updateItemDeleteModel(t,this.getModel().getProperty("/ITProcurement/itemData")):"";this.getModel().getProperty("/ITAppVisible/")==="SSA-IT-4001-2"?this.updateItemDeleteModel(t,this.getModel().getProperty("/ITProcurement/itemData")):"";this.getModel().getProperty("/ITAppVisible/")==="SSA-IT-4003-1"?this.updateItemDeleteModel(t,this.getModel().getProperty("/ITProcurement/itemData")):""},updateItemDeleteModel:function(e,t){t.splice(e,1);this.getModel().refresh()},handleLiveChangeQty:function(e){var t=parseInt(e.getSource().getBindingContext().getPath().split("/")[3]);var r=e.getSource().getValue()===""?"":parseInt(e.getSource().getValue());var i=e.getSource().getBindingContext().getObject().MaterialF4?e.getSource().getBindingContext().getObject().MaterialF4.split("-")[0]:"";var o=`/MaterialAvailabilitySet(Material='${i}',Qty='${r}')`;this.getModel().setProperty("/busy",true);this.getAPI.oDataACRUDAPICall(this.getOwnerComponent().getModel("ZSSP_SCM_SRV"),"GET",o,null).then(function(e){this.handleQtyChangeResponse(e,t);this.getModel().setProperty("/busy",false)}.bind(this)).catch(function(e){this._handleError(e);this.getModel().setProperty("/busy",false)}.bind(this))},handleQtyChangeResponse:function(e,t){debugger;this.getModel().setProperty(`/ITProcurement/itemData/${t}/StockAvailable/`,e.StockAvailable);this.getModel().setProperty(`/ITProcurement/itemData/${t}/TotalPrice/`,e.TotalPrice);this.getModel().setProperty(`/ITProcurement/itemData/${t}/UnitPrice/`,e.UnitPrice);const r=this.getModel().getProperty("/ITProcurement/itemData/").reduce((e,t)=>e+parseInt(t.TotalPrice),0);var i=r+.15*r;i=Number.isNaN(i)?0:i;this.getModel().setProperty("/ITProcurement/Header/EstPrice/",i)},onSearch:function(){this.oRouter.navTo("LandingView")},onFileAdded:function(e){debugger;var t=this;var r=e.getSource();var i=e.getParameter("files");if(i.length===0)return;var o=i[0].name,a=i[0].type,l=i[0],s=i[0].size;this._getImageData(l,function(e){t._addData(e,o,a,s)})},_addData:function(e,t,r,i){var o=this.getModel().getProperty("/UploadedData");if(o.length>=5){l.show("Upto 5 Documents are allowed to upload");return false}var a=o.map(function(e){return Object.assign({},e)});a.push({Filename:t,Mimetype:r,Value:e,Filesize:i});this.getModel().setProperty("/UploadedData",a)},onDeleteAttachment:function(e){var t=parseInt(e.getSource().getBindingContext().getPath().split("/")[3]);var r=this.getModel().getProperty("/UploadedData");r.splice(t,1);this.getModel().refresh();currentElement.removeStyleClass("remove-table")},handleMissmatch:function(){this.handleFileMissmatch()},onFileSizeExceed:function(){this.handleFileSizeExceed()},onCancel:function(){this.navigationBack()}})});