sap.ui.define(["./BaseController","sap/ui/core/routing/History","sap/ui/model/json/JSONModel","sap/ui/core/library","sap/m/MessageBox","sap/ui/core/Fragment","sap/ui/Device"],function(e,t,s,o,a,n,i){"use strict";return e.extend("com.swcc.Template.controller.DetailRequest",{onInit:function(){this.oRouter=this.getRouter();this.getRouter().getRoute("DetailRequest").attachPatternMatched(this._onObjectMatched,this)},_onObjectMatched:function(e){this._createDataModel();var t=e.getParameter("arguments").RequestID;this.getModel().setProperty("/sRequestid",t);this.RequestDetailsAPI(t)},_createDataModel:function(){this.getModel().setData({busy:false,ProcessFlowData:[],RequestDetails:{Header:{},Attachments:[]}})},RequestDetailsAPI:function(e){this.getModel().setProperty("/busy",true);var t=`/ViewRequestSet('${e}')`;var s={$expand:"Statuses,getAttachments"};this.getAPI.oDataACRUDAPICall(this.getOwnerComponent().getModel("ZSSP_COMMON_SRV"),"GET",t,null,null,s).then(function(e){debugger;this.getModel().setProperty("/busy",false);this.getModel().setProperty("/RequestDetails/Header/",e);e.Invoice===""?this.getModel().setProperty("/RequestDetails/Header/Invoice",""):this.getModel().setProperty("/RequestDetails/Header/Invoice","data:application/pdf;base64,"+e.Invoice);this.getModel().setProperty("/RequestDetails/Attachments/",e.getAttachments.results);var t=this.customResponseData(e.Statuses.results);this.getModel().setProperty("/ProcessFlowData/",t)}.bind(this)).catch(function(e){a.error(e.responseText);this.getModel().setProperty("/busy",false)}.bind(this))},onLanePress:function(e){const t=e.getSource();var s=t.getBindingContext().getObject().Date;var o=this.handleDateFormat(s);var a=this.handleTimeFormat(s);if(!this._popover){this._popover=new sap.m.Popover({title:t.getProperty("text"),contentWidth:"200px",contentHeight:"140px",content:[new sap.ui.layout.form.SimpleForm({layout:sap.ui.layout.form.SimpleFormLayout.ResponsiveGridLayout,content:[new sap.m.Label({text:"Date:"}),new sap.m.Text({text:o}),new sap.m.Label({text:"Time:"}),new sap.m.Text({text:a})]})]})}this._popover.openBy(t)},customResponseData:function(e){let t=0;let s=0;const o=e.filter(e=>e.Visible===true).map(e=>({id:(t++).toString(),icon:e.Icon,label:e.Description,position:s++,Date:e.Date,state:[{state:e.State,value:10}]}));return o},onCancel:function(){var e,s;e=t.getInstance();s=e.getPreviousHash();if(s!==undefined){window.history.go(-1)}else{this.getRouter().navTo("LandingView",{},true)}},handleBackPress:function(){var e,s;e=t.getInstance();s=e.getPreviousHash();if(s!==undefined){window.history.go(-1)}else{this.oRouter.navTo("ViewRequest",{StatusId:"NA"})}},itemPress:function(e){var t=e.getSource(),s=t.getCustomData(),o=s[0].getValue(),a=s[1].getValue(),n=s[2].getValue(),i=s[3].getValue();var r=new sap.m.Popover({contentWidth:"300px",title:"Order status",content:[new sap.m.HBox({items:[new sap.ui.core.Icon({src:a,color:this._getColorByState(t)}).addStyleClass("sapUiSmallMarginBegin sapUiSmallMarginEnd"),new sap.m.FlexBox({width:"100%",renderType:"Bare",direction:"Column",items:[new sap.m.Title({level:sap.ui.core.TitleLevel.H1,text:o}),new sap.m.Text({text:n}).addStyleClass("sapUiSmallMarginBottom sapUiSmallMarginTop"),new sap.m.Text({text:i})]})]}).addStyleClass("sapUiTinyMargin")],footer:[new sap.m.Toolbar({content:[new sap.m.ToolbarSpacer,new sap.m.Button({text:"Close",press:function(){r.close()}})]})]});r.openBy(e.getParameter("item"))},_getColorByState:function(e){switch(e.getState()){case"Error":return o.IconColor.Negative;case"Warning":return o.IconColor.Critical;case"Success":return o.IconColor.Positive}},onViewDoc:function(e){var t=e.getSource().getBindingContext().getObject().Value;this.getModel().setProperty("/pdf","data:application/pdf;base64,"+t);var s=this.getView();if(!this.oSearchResultDialog){n.load({id:s.getId(),name:"com.swcc.Template.fragments.ViewRequest.OpenAttachmentDialog",controller:this}).then(function(e){e.setTitle("Attachments Details");this.oSearchResultDialog=e;this.getView().addDependent(e);e.open()}.bind(this))}else{this.oSearchResultDialog.open()}},onCloseAttachment:function(){this.oSearchResultDialog.close()},onApprovePress:function(){this.AssignRequestAPI({Status:"APPROVE"},"Approved")},onRejectPress:function(){this.AssignRequestAPI({Status:"REJECT"},"Rejected")},onCloseRequestPress:function(e){var t={sMsgTxt:`Please note that the cancellation charges will be levied if the request has been open for more than 24 hours`,sBtnTxt:"OK"};this.handleConfirmMessage(this.onCloseRequestPress1.bind(this))(t)},onCloseRequestPress1:function(){this.AssignRequestAPI({Status:"CLOSE"},"Closed")},AssignRequestAPI:function(e,t){debugger;var s=`/ViewRequestSet(RequestID='${this.getModel().getProperty("/sRequestid")}')`;this.getModel().setProperty("/busy",true);this.getAPI.oDataACRUDAPICall(this.getOwnerComponent().getModel("ZSSP_COMMON_SRV"),"PUT",s,e).then(function(e){this.getModel().setProperty("/busy",false);this._handleMessageBoxProceed(`Request has been successfully ${t}`);this.RequestDetailsAPI(this.getModel().getProperty("/sRequestid"))}.bind(this)).catch(function(e){a.error(e.responseText);this.getModel().setProperty("/busy",false)}.bind(this))},_handleMessageBoxProceed:function(e){var t={sMessage:e};this.createMessageBoxHandler(this.onPresshomepage.bind(this))(t)},onPresshomepage:function(){this.getOwnerComponent().getRouter().navTo("HomePage")}})});